<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="á»¨ng dá»¥ng quáº£n lÃ½ há»c táº­p cho lá»›p 10A1 - Sá»­ dá»¥ng Ä‘Æ°á»£c offline">
  <title>10C7 AIO</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='60' font-size='80' text-anchor='middle'>ğŸ“š</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23667eea' width='180' height='180'/><text x='90' y='100' font-size='90' font-weight='bold' fill='white' text-anchor='middle'>ğŸ“š</text></svg>">
  <link rel="stylesheet" href="style/hub.css">
  <link rel="stylesheet" href="style/console.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <h1>ğŸ“š Lá»›p há»c 10C7</h1>
        <p>Trung tÃ¢m quáº£n lÃ½ há»c táº­p</p>
      </div>
      <div class="header-right">
        <button class="admin-toggle" id="adminToggle" onclick="toggleAdminMode()" style="display:none;" title="Cháº¿ Ä‘á»™ Admin">âš™ï¸</button>
        <button class="logout-btn" onclick="handleLogout()" title="ÄÄƒng xuáº¥t">
          <span id="userNameDisplay">ğŸ‘¤</span>
        </button>
      </div>
    </div>
  </header>

  <!-- ADMIN TABS (Chá»‰ hiá»‡n vá»›i Admin/CÃ³ quyá»n) -->
  <div id="hubAdminTabs" class="admin-tabs-container" style="display:none;">
    <button class="hub-tab-btn active" onclick="switchHubTab('dashboard')">ğŸ  Dashboard</button>
    <button class="hub-tab-btn" id="tabBtnStudents" onclick="switchHubTab('students')" style="display:none;">ğŸ‘¨â€ğŸ“ Há»c sinh</button>
    <button class="hub-tab-btn" id="tabBtnRoles" onclick="switchHubTab('roles')" style="display:none;">âš™ï¸ PhÃ¢n quyá»n</button>
    <button class="hub-tab-btn" id="tabBtnLogs" onclick="switchHubTab('logs')" style="display:none;">ğŸ“œ Logs</button>
  </div>

  <!-- TAB CONTENT: DASHBOARD (Máº·c Ä‘á»‹nh) -->
  <div id="tabContent_dashboard" class="hub-tab-content active">
  <!-- Welcome Banner -->
  <section class="welcome-section">
    <div class="welcome-content">
      <h2>ğŸ‘‹ Xin chÃ o, <span id="welcomeName">báº¡n</span>!</h2>
      <p id="welcomeMessage">ChÃºc báº¡n má»™t ngÃ y há»c táº­p hiá»‡u quáº£!</p>
    </div>
  </section>

  <!-- Thá»‘ng kÃª -->
  <section class="stats-section">
    <h2 class="section-title">ğŸ“Š Tá»•ng Quan Há»c Táº­p</h2>
    <div class="stats-grid">
      <div class="stat-card" onclick="go('nhiemvu/nv.html')">
        <div class="stat-icon-wrapper">
          <span class="stat-icon">ğŸ“‹</span>
        </div>
        <div class="stat-content">
          <span class="stat-label">Tá»•ng Task</span>
          <span class="stat-value" id="totalTask">0</span>
        </div>
        <div class="stat-indicator"></div>
      </div>
      <div class="stat-card" onclick="go('nhiemvu/nv.html')">
        <div class="stat-icon-wrapper">
          <span class="stat-icon">ğŸ”„</span>
        </div>
        <div class="stat-content">
          <span class="stat-label">Äang má»Ÿ</span>
          <span class="stat-value" id="openTask">0</span>
        </div>
        <div class="stat-indicator"></div>
      </div>
      <div class="stat-card" onclick="go('thongke/tk.html')">
        <div class="stat-icon-wrapper">
          <span class="stat-icon">âœ…</span>
        </div>
        <div class="stat-content">
          <span class="stat-label">HoÃ n thÃ nh</span>
          <span class="stat-value" id="doneTask">0</span>
        </div>
        <div class="stat-indicator success"></div>
      </div>
      <div class="stat-card" onclick="go('nhiemvu/nv.html')">
        <div class="stat-icon-wrapper">
          <span class="stat-icon">â°</span>
        </div>
        <div class="stat-content">
          <span class="stat-label">Sáº¯p háº¿t háº¡n</span>
          <span class="stat-value" id="nearDeadline">0</span>
        </div>
        <div class="stat-indicator warning"></div>
      </div>
    </div>
  </section>

  <!-- Äiá»u hÆ°á»›ng -->
  <section class="nav-section">
    <h2 class="section-title">ğŸš€ Äiá»u HÆ°á»›ng Nhanh</h2>
    <div class="nav-grid">
      <button class="nav-btn nav-btn-primary" onclick="go('nhiemvu/nv.html')">
        <span class="nav-icon">ğŸ“Œ</span>
        <span class="nav-text">Nhiá»‡m vá»¥</span>
        <span class="nav-desc">Quáº£n lÃ½ cÃ´ng viá»‡c</span>
      </button>
      <button class="nav-btn nav-btn-success" onclick="go('thongke/tk.html')">
        <span class="nav-icon">ğŸ“Š</span>
        <span class="nav-text">Thá»‘ng kÃª</span>
        <span class="nav-desc">Xem tiáº¿n Ä‘á»™</span>
      </button>
      <button class="nav-btn nav-btn-info" onclick="go('thongbao/tb.html')">
        <span class="nav-icon">ğŸ””</span>
        <span class="nav-text">ThÃ´ng bÃ¡o</span>
        <span class="nav-desc">Cáº­p nháº­t tin tá»©c</span>
      </button>
      <button class="nav-btn nav-btn-calendar" onclick="go('lich/lich.html')">
        <span class="nav-icon">ğŸ“…</span>
        <span class="nav-text">Lá»‹ch há»c</span>
        <span class="nav-desc">Xem thá»i khoÃ¡ biá»ƒu</span>
      </button>
      <button class="nav-btn nav-btn-admin" onclick="go('hoso/hs.html')" id="adminManageBtn" style="display:none; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white;">
        <span class="nav-icon">ğŸ“‚</span>
        <span class="nav-text">Há»“ sÆ¡</span>
        <span class="nav-desc">Quáº£n lÃ½ lá»›p há»c</span>
      </button>
    </div>
  </section>

  <!-- Task gáº§n nháº¥t -->
  <section class="recent-section">
    <div class="section-header">
      <h2>â° Task Gáº§n Háº¡n</h2>
      <a href="nhiemvu/nv.html" class="view-all">Xem táº¥t cáº£ â†’</a>
    </div>
    <div class="recent-container">
      <ul class="recent-list" id="recentTasks">
        <!-- Ná»™i dung Ä‘Æ°á»£c táº¡o bá»Ÿi script -->
      </ul>
      <div class="empty-state" id="emptyState" style="display: none;">
        <span class="empty-icon">ğŸ‰</span>
        <p>KhÃ´ng cÃ³ task sáº¯p háº¿t háº¡n!</p>
      </div>
    </div>
  </section>
  </div> <!-- End tabContent_dashboard -->

  <!-- TAB CONTENT: STUDENTS -->
  <div id="tabContent_students" class="hub-tab-content" style="display:none;">
    <div class="table-container" style="padding: 20px;">
      <div class="table-header" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <input type="text" id="hubSearchInput" placeholder="ğŸ” TÃ¬m há»c sinh..." onkeyup="searchHubStudents()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 300px;">
        <button class="add-btn" onclick="openHubStudentModal()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">+ ThÃªm há»c sinh</button>
      </div>
      <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <table class="students-table" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa; text-align: left;">
              <th style="padding: 12px;">STT</th>
              <th style="padding: 12px;">Há» vÃ  tÃªn</th>
              <th style="padding: 12px;">Chá»©c vá»¥</th>
              <th style="padding: 12px;">NgÃ y sinh</th>
              <th style="padding: 12px;">LiÃªn há»‡</th>
              <th style="padding: 12px;">HÃ nh Ä‘á»™ng</th>
            </tr>
          </thead>
          <tbody id="hubStudentsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB CONTENT: ROLES -->
  <div id="tabContent_roles" class="hub-tab-content" style="display:none;">
    <div class="roles-matrix-container" style="overflow-x: auto; background: white; padding: 20px; margin: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);"></div>
    <div style="padding: 0 20px;"><button onclick="saveRolesConfig()" style="margin-top: 15px; padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ’¾ LÆ°u Cáº¥u HÃ¬nh PhÃ¢n Quyá»n</button></div>
  </div>

  <!-- TAB CONTENT: LOGS -->
  <div id="tabContent_logs" class="hub-tab-content" style="display:none;">
    <div class="logs-container" style="overflow-x: auto; background: white; padding: 20px; margin: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);"></div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 Lá»›p 10A1. Táº¥t cáº£ quyá»n Ä‘Æ°á»£c báº£o lÆ°u.</p>
    <p class="online-status" id="onlineStatus">ğŸŸ¢ Online</p>
  </footer>

  <!-- MODAL STUDENT (For Hub) -->
  <div id="hubStudentModal" class="modal" style="display: none; z-index: 10000; align-items: center; justify-content: center;">
    <div class="modal-content" style="max-width: 500px; width: 90%; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
      <div class="modal-header" style="background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h2 id="hubModalTitle" style="margin: 0; font-size: 1.2rem;">ThÃ´ng tin há»c sinh</h2>
        <button onclick="closeHubStudentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
      </div>
      <div class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Chá»©c vá»¥ (*)</label>
          <select id="hubStdRole" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></select>
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Há» vÃ  tÃªn (*)</label>
          <input type="text" id="hubStdName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div class="form-row" style="display: flex; gap: 10px; margin-bottom: 15px;">
          <div style="flex: 1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">NgÃ y sinh</label>
            <input type="date" id="hubStdDob" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="flex: 1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Giá»›i tÃ­nh</label>
            <select id="hubStdGender" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="Nam">Nam</option>
              <option value="Ná»¯">Ná»¯</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
          <input type="tel" id="hubStdPhone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email</label>
          <input type="email" id="hubStdEmail" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button id="btnDeleteHubStudent" onclick="deleteHubStudent()" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">XÃ³a</button>
          <button onclick="saveHubStudent()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ’¾ LÆ°u</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="script/firebase-config.js"></script>
<script>firebase.initializeApp(firebaseConfig);</script>
<script src="script/firebase-utils.js"></script>
<script src="script/students-list.js"></script>
<script src="script/console.js"></script>
<script src="script/hub.js"></script>

<!-- Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // ÄÄƒng kÃ½ vá»›i scope tÆ°Æ¡ng Ä‘á»‘i Ä‘á»ƒ há»— trá»£ GitHub Pages
        navigator.serviceWorker.register('./service-worker.js')
        .then(registration => {
          console.log('âœ… Service Worker Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½:', registration);

          // Kiá»ƒm tra update má»—i 10 giÃ¢y
          setInterval(() => {
            registration.update();
          }, 10000);

          // Láº¯ng nghe cáº­p nháº­t service worker
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('ğŸ”„ PhiÃªn báº£n má»›i cÃ³ sáºµn! Cáº­p nháº­t tá»± Ä‘á»™ng...');
                setTimeout(() => {
                  window.location.reload();
                }, 2000);
              }
            });
          });
        })
        .catch(error => {
          console.log('âŒ Service Worker Ä‘Äƒng kÃ½ tháº¥t báº¡i:', error);
        });
    });
  }

  // Check user login
  window.addEventListener('load', () => {
    if (!isLoggedIn()) {
      window.location.href = buildUrl('login.html');
      return;
    }

    const user = getCurrentUser();
    console.log('âœ… ÄÃ£ Ä‘Äƒng nháº­p:', user.name);
    document.getElementById('userNameDisplay').textContent = user.name;

    // Hiá»‡n nÃºt Admin náº¿u lÃ  admin
    if (isAdmin()) {
      document.getElementById('adminToggle').style.display = 'inline-block';
      document.getElementById('adminManageBtn').style.display = 'flex';
    }

    // Cáº­p nháº­t welcome message
    updateWelcomeMessage();
    
    // Load stats
    loadStats();
    
    // Cáº­p nháº­t tráº¡ng thÃ¡i káº¿t ná»‘i
    updateOnlineStatus();
    
    // Táº£i láº¡i stats má»—i 30 giÃ¢y
    setInterval(() => {
      loadStats();
    }, 30000);
  });

  // Xá»­ lÃ½ Ä‘Äƒng xuáº¥t
  function handleLogout() {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t?')) {
      logoutUser();
      window.location.href = buildUrl('login.html');
    }
  }

  // Toggle cháº¿ Ä‘á»™ Admin
  let adminMode = false;
  function toggleAdminMode() {
    adminMode = !adminMode;
    console.log(adminMode ? 'ğŸ”“ Cháº¿ Ä‘á»™ Admin ON' : 'ğŸ”’ Cháº¿ Ä‘á»™ Admin OFF');
  }

  // Gá»£i Ã½ ngÆ°á»i dÃ¹ng cÃ i Ä‘áº·t á»©ng dá»¥ng
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', event => {
    event.preventDefault();
    deferredPrompt = event;
  });

  // Kiá»ƒm tra káº¿t ná»‘i máº¡ng
  window.addEventListener('online', () => {
    console.log('âœ… Báº¡n Ä‘Ã£ online');
  });

  window.addEventListener('offline', () => {
    console.log('âš ï¸ Báº¡n Ä‘Ã£ offline - Sá»­ dá»¥ng dá»¯ liá»‡u Ä‘Ã£ cached');
  });
</script>